<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa de Bidones Entregados</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <style>
    body { margin:0; font-family:sans-serif; }
    #map { height: 90vh; width: 100vw; }
    #filtros {
      padding:10px;
      background:#f4f4f4;
      border-bottom:1px solid #ccc;
      font-size:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    #filtros label {
      display:flex;
      align-items:center;
      gap:4px;
    }
    #filtros input, #filtros select {
      padding:4px;
    }
    button {
      padding:6px 12px;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    #btnAplicar { background:#1f6feb; color:#fff; }
    #btnReset { background:#aaa; color:#fff; }
  </style>
</head>
<body>
  <div id="filtros">
    <label>Fecha desde: <input type="date" id="fDesde"></label>
    <label>Fecha hasta: <input type="date" id="fHasta"></label>
    <label>Usuario:
      <select id="fUsuario">
        <option value="">-- Todos --</option>
      </select>
    </label>
    <label>Hora desde: <input type="time" id="hDesde"></label>
    <label>Hora hasta: <input type="time" id="hHasta"></label>
    <button id="btnAplicar" onclick="cargarDatos()">Aplicar filtros</button>
    <button id="btnReset" onclick="resetFiltros()">Limpiar</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // 游녤 Peg치 tu URL publicada como CSV
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqDkwsACbL8CGsWV7X8pAwtfBUmvjjPTX0ca-LwD_xE5eeEq9--FFw7Z0U62Z9fD9vuKv96KPk1ws6/pub?gid=0&single=true&output=csv";

    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const markers = L.markerClusterGroup();
    map.addLayer(markers);

    let allRows = []; // guardamos todos los datos para reutilizar

    async function fetchDatos() {
      const resp = await fetch(CSV_URL);
      const csvText = await resp.text();
      return new Promise(resolve => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: results => resolve(results.data)
        });
      });
    }

    function popularUsuarios() {
      const sel = document.getElementById("fUsuario");
      sel.innerHTML = `<option value="">-- Todos --</option>`;
      const usuarios = [...new Set(allRows.map(r => r.Usuario).filter(Boolean))];
      usuarios.sort().forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        sel.appendChild(opt);
      });
    }

    function cargarDatos() {
      markers.clearLayers();
      const puntos = [];

      const fDesde = document.getElementById("fDesde").value;
      const fHasta = document.getElementById("fHasta").value;
      const fUsuario = document.getElementById("fUsuario").value;
      const hDesde = document.getElementById("hDesde").value;
      const hHasta = document.getElementById("hHasta").value;

      allRows.forEach(row => {
        if (row.TipoMovimiento !== "Entregado") return;
        if (!row.Ubicaci칩n) return;

        const coords = row.Ubicaci칩n.split(",").map(Number);
        if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;

        const fecha = new Date(row.FechaHora);
        if (isNaN(fecha)) return;

        // filtros
        if (fDesde && fecha < new Date(fDesde)) return;
        if (fHasta && fecha > new Date(fHasta + "T23:59:59")) return;
        if (fUsuario && row.Usuario !== fUsuario) return;

        if (hDesde) {
          const [h,m] = hDesde.split(":").map(Number);
          const desdeMin = h*60+m;
          const actualMin = fecha.getHours()*60+fecha.getMinutes();
          if (actualMin < desdeMin) return;
        }
        if (hHasta) {
          const [h,m] = hHasta.split(":").map(Number);
          const hastaMin = h*60+m;
          const actualMin = fecha.getHours()*60+fecha.getMinutes();
          if (actualMin > hastaMin) return;
        }

        const marker = L.marker([coords[0], coords[1]])
          .bindPopup(`
            <b>${row.TipoMovimiento}</b><br>
            Bid칩n: ${row.CodigoBidon}<br>
            Usuario: ${row.Usuario}<br>
            Fecha: ${row.FechaHora}
          `);

        markers.addLayer(marker);
        puntos.push([coords[0], coords[1]]);
      });

      if (puntos.length > 0) {
        map.fitBounds(puntos);
      } else {
        map.setView([-34.6, -58.4], 12);
      }
    }

    function resetFiltros() {
      document.getElementById("fDesde").value = "";
      document.getElementById("fHasta").value = "";
      document.getElementById("fUsuario").value = "";
      document.getElementById("hDesde").value = "";
      document.getElementById("hHasta").value = "";
      cargarDatos();
    }

    (async () => {
      allRows = await fetchDatos();
      popularUsuarios();
      cargarDatos();
    })();
  </script>
</body>
</html>
