<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Entrega de Bid√≥n</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root{
      --bg:#f6f7fb; --text:#1f2937; --primary:#1f6feb; --ok:#16a34a; --err:#e11d48;
      --muted:#6b7280; --card:#ffffff; --border:#e5e7eb; --shadow:0 8px 24px rgba(0,0,0,.08);
      --cancel:#9ca3af;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}
    header{padding:16px;text-align:center;background:linear-gradient(90deg,#1f6feb,#5a79ef);color:#fff}
    header h1{margin:0;font-size:clamp(18px,4vw,24px)}
    main{max-width:520px;margin:20px auto;padding:20px;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .field{margin-bottom:14px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#111827}
    input[type="email"],input[type="text"],input[type="number"]{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:16px;outline:none}
    input:focus{border-color:var(--primary)}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    .btn{appearance:none;border:none;border-radius:12px;padding:14px 16px;font-size:16px;cursor:pointer;transition:transform .05s ease;color:#fff;box-shadow:var(--shadow)}
    .btn:active{transform:scale(.98)}
    .btn-scan{background:#2563eb;white-space:nowrap}
    .btn-entrega{background:var(--ok);width:100%}
    .muted{color:var(--muted);font-size:14px}
    #qr-reader{display:none;width:100%;max-width:480px;margin:10px auto 0}
    #mensaje{margin-top:12px;min-height:24px}
    .ok{color:var(--ok)} .error{color:var(--err)}

    /* Modal de confirmaci√≥n */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999;padding:12px}
    .modal-card{position:relative;background:#fff;width:100%;max-width:520px;border-radius:18px;padding:24px;box-shadow:var(--shadow);text-align:center;animation:pop .15s ease-out}
    @keyframes pop{from{transform:scale(.98);opacity:.8}to{transform:scale(1);opacity:1}}
    .modal-cancel{position:absolute;top:10px;right:10px;background:var(--cancel);border:none;color:#fff;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .mov-title{margin:0 0 6px 0;color:#111827;font-size:16px}
    .bidon-giant{font-size:clamp(44px,12vw,72px);font-weight:800;letter-spacing:1px;color:#111827;margin:6px 0 2px}
    .mov-sub{margin:0;color:var(--muted)}
    .ubic-line{margin:8px 0 14px;color:#111827}
    .confirm-btn{background:var(--ok);border:none;border-radius:12px;padding:14px 18px;font-size:18px;cursor:pointer;width:100%}

    .foot{margin-top:10px;font-size:12px;color:#6b7280;word-break:break-all}
  </style>
</head>
<body>
  <header><h1>Entrega de Bid√≥n</h1></header>

  <main>
    <div class="field">
      <label for="email">Tu correo (obligatorio)</label>
      <input type="email" id="email" placeholder="ejemplo@correo.com" />
    </div>

    <div class="field">
      <label for="ubicacion">Ubicaci√≥n (obligatorio para Entrega)</label>
      <input type="text" id="ubicacion" placeholder="Ej: Dep√≥sito Norte / Cliente X" />
    </div>

    <div class="field">
      <label for="codigo">C√≥digo de Bid√≥n (solo n√∫meros)</label>
      <div class="row">
        <input type="number" id="codigo" placeholder="Ej: 123" />
        <button class="btn btn-scan" onclick="iniciarEscaneo()">üì∑ QR</button>
      </div>
      <div id="qr-reader"></div>
      <p class="muted">Este formulario solo registra <strong>Entregado</strong>.</p>
    </div>

    <div class="field">
      <button class="btn btn-entrega" onclick="preConfirmar()">Registrar Entrega</button>
    </div>

    <div id="mensaje"></div>

    <div class="foot">
      API: <span id="apiEcho"></span>
    </div>
  </main>

  <!-- Modal de confirmaci√≥n -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
    <div class="modal-card">
      <button class="modal-cancel" id="cancelar">Cancelar</button>
      <p id="confirm-title" class="mov-title">Vas a registrar:</p>
      <div class="bidon-giant" id="giantBidon">#‚Äî</div>
      <p class="mov-sub">Movimiento: <strong>Entregado</strong></p>
      <p class="ubic-line" id="modalUbic"></p>
      <button id="confirmar" class="confirm-btn">Aceptar</button>
    </div>
  </div>

  <script>
    // üîß PON√â TU URL /exec AC√Å:
    const API_URL = "https://script.google.com/macros/s/AKfycbzAEGG01rKGr-YqNNQjoue_7gMt8LNgqhP6mj4VC9JYI7-lmfties5GsC50K8Z8N3vu_A/exec";

    // Utilidades
    function isValidEmail(email){
      // Regex simple y suficiente para validaci√≥n b√°sica
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Echo para verificar r√°pidamente que se configur√≥ la API
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("apiEcho").textContent = API_URL;
      const savedEmail = localStorage.getItem("usuarioEmail");
      if (savedEmail) document.getElementById("email").value = savedEmail;
    });

    document.getElementById("email").addEventListener("change", () => {
      const email = document.getElementById("email").value.trim();
      if (isValidEmail(email)) {
        localStorage.setItem("usuarioEmail", email);
      }
    });

    let html5QrCode = null;
    async function iniciarEscaneo() {
      const qrReader = document.getElementById("qr-reader");
      qrReader.style.display = "block";
      try {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            if (/^\d+$/.test(decodedText)) {
              document.getElementById("codigo").value = decodedText;
              abrirConfirmacion();
            } else {
              alert("‚ö†Ô∏è El QR no contiene un n√∫mero v√°lido de bid√≥n.");
            }
            html5QrCode.stop().then(() => { qrReader.style.display = "none"; });
          },
          (err) => console.log("Escaneo fallido:", err)
        );
      } catch (err) {
        console.error("Error al iniciar c√°mara:", err);
        qrReader.innerHTML = "<p class='error'>‚ö†Ô∏è No se pudo acceder a la c√°mara</p>";
      }
    }

    function preConfirmar(){
      abrirConfirmacion();
    }

    function abrirConfirmacion(){
      const email = document.getElementById("email").value.trim();
      const codigo = document.getElementById("codigo").value.trim();
      const ubic = document.getElementById("ubicacion").value.trim();
      const msgDiv = document.getElementById("mensaje");
      msgDiv.innerHTML = "";

      if (!email || !isValidEmail(email)) {
        msgDiv.innerHTML = "<p class='error'>‚ö†Ô∏è Ingres√° un correo v√°lido.</p>"; return;
      }
      if (!codigo || !/^\d+$/.test(codigo)) {
        msgDiv.innerHTML = "<p class='error'>‚ö†Ô∏è Ingres√° un c√≥digo num√©rico de bid√≥n.</p>"; return;
      }
      if (!ubic) {
        msgDiv.innerHTML = "<p class='error'>‚ö†Ô∏è La ubicaci√≥n es obligatoria para Entrega.</p>"; return;
      }

      localStorage.setItem("usuarioEmail", email);

      document.getElementById("giantBidon").textContent = `#${codigo}`;
      document.getElementById("modalUbic").textContent = `Ubicaci√≥n: ${ubic}`;
      const modal = document.getElementById("modal");
      modal.style.display = "flex";
      if (navigator.vibrate) navigator.vibrate(80);

      const btn = document.getElementById("confirmar");
      btn.onclick = () => confirmarEntrega(email, codigo, ubic);
    }

    document.getElementById("cancelar").addEventListener("click", () => {
      document.getElementById("modal").style.display = "none";
    });
    document.getElementById("modal").addEventListener("click", (e) => {
      if (e.target.id === "modal") document.getElementById("modal").style.display = "none";
    });

    async function confirmarEntrega(email, codigo, ubicacion){
      const msgDiv = document.getElementById("mensaje");
      msgDiv.innerHTML = "";
      document.getElementById("modal").style.display = "none";

      try {
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            id_bidon: codigo,
            tipo_movimiento: "Entregado",
            usuario: email,
            ubicacion: ubicacion
          })
        });
        const result = await resp.json();
        if (result.status === "duplicate") {
          msgDiv.innerHTML = `<p class="error">‚ùå ${result.message} (√öltimo: ${result.last_mov} ‚Äî ${result.last_ts})</p>`;
          return;
        }
        if (result.ok) {
          msgDiv.innerHTML = `<p class="ok">‚úÖ ${result.message}</p>`;
          document.getElementById("codigo").value = "";
        } else {
          msgDiv.innerHTML = `<p class="error">‚ùå ${result.error || "Ocurri√≥ un error"}.</p>`;
        }
      } catch (e) {
        console.error(e);
        msgDiv.innerHTML = "<p class='error'>‚ö†Ô∏è Error al conectar con el servidor.</p>";
      }
    }
  </script>
</body>
</html>
