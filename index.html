<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Entrega de Bid√≥n</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      background:#f9fafb;
      margin:0; padding:20px;
      text-align:center;
      color:#333;
    }
    h1 { margin-bottom:20px; }
    input {
      padding:12px; margin:10px 0;
      width:100%; max-width:350px;
      border:1px solid #ccc; border-radius:6px;
      font-size:16px;
    }
    button {
      padding:14px 22px; border:none; border-radius:8px;
      font-size:18px; cursor:pointer; margin:10px;
    }
    .btn-scan { background:#3498db; color:#fff; }
    .btn-send { background:#27ae60; color:#fff; }
    .error { color:#e74c3c; margin-top:10px; }
    .ok { color:#27ae60; margin-top:10px; }
    #qr-reader { display:none; margin:10px auto; width:100%; max-width:350px; }

    /* Modal */
    .modal {position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5);}
    .modal-card {position:relative; background:#fff; padding:20px; border-radius:12px; text-align:center; max-width:400px; width:90%;}
    .modal-cancel {position:absolute; top:8px; right:8px; font-size:14px; background:#ccc; border:none; border-radius:50%; padding:4px 8px; cursor:pointer;}
    .bidon {font-size:48px; font-weight:bold; margin:20px 0;}
    .mov {color:#27ae60; font-weight:bold; margin-bottom:20px;}
    .btn-confirm {background:#27ae60; color:#fff; font-size:18px; padding:14px 22px; border:none; border-radius:8px; width:100%;}
  </style>
</head>
<body>
  <h1>Entrega de Bid√≥n</h1>

  <input type="email" id="email" placeholder="Tu correo (obligatorio)" />
  <br>
  <input type="number" id="codigo" placeholder="C√≥digo de bid√≥n" />
  <br>
  <button class="btn-scan" onclick="iniciarEscaneo()">üì∑ Escanear QR</button>
  <div id="qr-reader"></div>
  <br>
  <button class="btn-send" onclick="preConfirmar()">Enviar</button>

  <div id="mensaje"></div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-card">
      <button class="modal-cancel" onclick="cerrarModal()">‚úï</button>
      <div class="bidon" id="modalBidon">#---</div>
      <div class="mov">Entregado</div>
      <button class="btn-confirm" onclick="confirmar()">Confirmar</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxvKMFKAduShnTYy9p_j0tCKvzH_eJRMY3zj7RyDdwecllfRg_sQgkOIFSj-ZOm3vJnhw/exec";
    let html5QrCode = null;
    let coords = {lat:null, lon:null};

    // Pedir ubicaci√≥n
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => { coords.lat = pos.coords.latitude; coords.lon = pos.coords.longitude; },
        err => console.warn("No se pudo obtener ubicaci√≥n:", err),
        { enableHighAccuracy:true }
      );
    }

    function iniciarEscaneo() {
      const qrReader = document.getElementById("qr-reader");
      qrReader.style.display = "block";
      if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode:"environment" },
        { fps:10, qrbox:250 },
        decodedText => {
          if (/^\d+$/.test(decodedText)) {
            document.getElementById("codigo").value = decodedText;
            html5QrCode.stop(); qrReader.style.display = "none";
          } else {
            alert("‚ö†Ô∏è QR inv√°lido");
          }
        }
      ).catch(err => {
        console.error("Error c√°mara:", err);
        qrReader.innerHTML = "<p class='error'>‚ö†Ô∏è No se pudo acceder a la c√°mara</p>";
      });
    }

    function preConfirmar() {
      const email = document.getElementById("email").value.trim();
      const codigo = document.getElementById("codigo").value.trim();
      const msgDiv = document.getElementById("mensaje");
      msgDiv.innerHTML = "";
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        msgDiv.innerHTML = "<p class='error'>‚ö†Ô∏è Ingres√° un correo v√°lido.</p>"; return;
      }
      if (!codigo) {
        msgDiv.innerHTML = "<p class='error'>‚ö†Ô∏è Ingres√° un c√≥digo de bid√≥n.</p>"; return;
      }
      document.getElementById("modalBidon").textContent = "#" + codigo;
      document.getElementById("modal").style.display = "flex";
    }

    function cerrarModal() {
      document.getElementById("modal").style.display = "none";
    }

    async function confirmar() {
      cerrarModal();
      const email = document.getElementById("email").value.trim();
      const codigo = document.getElementById("codigo").value.trim();
      const msgDiv = document.getElementById("mensaje");
      msgDiv.innerHTML = "‚è≥ Enviando...";

      try {
        const resp = await fetch(API_URL, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            id_bidon: codigo,
            tipo_movimiento: "Entregado",
            usuario: email,
            ubicacion: `${coords.lat || ""},${coords.lon || ""}`
          })
        });

        let text = await resp.text(); // leemos crudo primero
        console.log("Respuesta cruda:", text);

        let result;
        try {
          result = JSON.parse(text);
        } catch(parseErr) {
          msgDiv.innerHTML = `<p class="error">‚ùå No se pudo parsear respuesta: ${parseErr.message}. Respuesta: ${text}</p>`;
          return;
        }

        if (result.ok) {
          msgDiv.innerHTML = `<p class="ok">‚úÖ ${result.message}</p>`;
          document.getElementById("codigo").value = "";
        } else {
          msgDiv.innerHTML = `<p class="error">‚ùå ${result.error || "Ocurri√≥ un error"}</p>`;
        }

      } catch(err) {
        console.error("Fetch error:", err);
        msgDiv.innerHTML = `<p class='error'>‚ö†Ô∏è Error al conectar con el servidor: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
